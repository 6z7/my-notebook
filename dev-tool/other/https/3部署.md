# 部署HTTPS

## 密钥

私钥是TLS安全的基石，为私钥选择恰当的密钥算法和长度，TLS可以提供高强度的安全性（在现有计算条件下需要很多年才能被破解）。实际上，抛开数学方面的考虑（位数越高越安全）, TLS最大的弱点在于密钥的管理，或者说如何保护私钥的私密性。

### 密钥算法

目前TLS支持3种算法，但实际上只有RSA这一种被广泛使用；DSA已经被废弃，而ECDSA有望被广泛使用。

* DSA

    DSA算法很容易被排除：因为DSA的密钥长度最大只能到1024位，这个位数根本无法确保安全性

* RSA

    RSA算法是最常见的一种选择，基本上所有的TLS部署都会支持RSA算法。但是，RSA在2048位（最小位数）的密钥下，比ECDSA密钥在安全性上更弱并且性能更差。更糟的是，增加RSA密钥长度是性能消耗的增加并不是线性的，如果你觉得2048位的加密强度不够，需要使用更高的位数（比如3072位）的RSA密钥时，在性能上就会有极大幅度的下降。

* ECDSA

    ECDSA算法是未来的选择。256位的ECDSA密钥有128位用于安全加密上，相对而言，2048位的RSA密钥只有112位是真正用于安全加密的。不仅如此，在这个加密强度下，ECDSA比RSA算法更快。

    因为椭圆曲线（elliptic curve, EC）算法是最近才被加入到TLS的安全体系中，所以ECDSA的问题在于：不是所有用户端都支持这种算法。新的浏览器都支持ECDSA，但是一些老版本的浏览器是不支持这个算法的。你可以通过同时部署RSA和ECDSA的密钥来解决对新老浏览器的兼容，但并不是所有服务程序都能提供这种配置方式，另外这种方案也需要额外的工作来同时维护两套密钥和证书。


### 密钥长度

在密钥长度方面，大部分系统部署只需要2048位RSA密钥或者256位ECDSA密钥，分别提供112位和128位的加密强度。也就是说，大部分系统部署可以使用算法的最低安全密钥长度，因为即使如此系统也足以满足用户的安全需求。

### 密钥管理

* 保证私钥的私密性

    把你的私钥作为最重要的资产来保护，在条件允许的范围内，只给最少的员工提供访问权限。有些CA会提供生成私钥的功能，务必不要使用这些功能；事实上这些CA有必要提高一下自己的安全意识。私钥的名称已经说明一切，无论什么情况下，都必须保证私钥的私密性。

* 仔细选择随机数生成器

    密钥的安全性依赖于计算机上随机数生成器（random numbergenerator, RNG）的质量，密钥的生成也离不开随机数生成器。有一种常见的场景是在服务器刚安装完并重新启动时完成了密钥的生成，但是在这个点上服务器可能还没有足够的随机信息（熵）用于生成强密钥。更好的密钥生成办法是：使用一个独立的（离线的）服务器，并且确保服务器上已经部署了一个强壮的RNG。  

* 保护密钥的密码

    密钥在生成时都需要一个密码用于密钥创建，同时这个密码也用于保护密钥的内容。假如你的密钥备份被窃取，也无法被直接用于攻击。这同样也有助于在计算机之间复制密钥时（直接复制或者使用U盘）避免密钥内容的泄露。

 * 不要随意共享密钥

 * 定期更新密钥

 * 安全存储密钥   


## 证书

证书选择需要做很多方面的考虑：包括使用什么类型的证书，每个证书需要包含哪些域名，使用哪家CA来签发证书，等等。

### 证书类型

证书主要有三种类型：域名验证（domain validated, DV）、组织验证（organization validated, OV）和扩展验证（extended validation,EV）。DV证书的签发是自动的，通常也是最便宜的，一般的网站使用DV证书就足够了。OV证书需要验证域名拥有者的公司信息，并且在证书中包含公司信息。尽管如此，浏览器实际上并不区分OV和DV证书，也不会展示出证书包含的所有信息。

EV证书在以下几个方面与DV和OV证书不同：(1) EV的验证过程符合CAB论坛标准；(2) 公司信息显示在浏览器地址栏并突出显示为绿色；(3) 浏览器对EV证书的证书吊销支持更好一些。从安全角度讲，EV证书并无多少改善，但它们确实能给用户更好的体验，对于某些业务来讲，这种体验可能很有价值。

### 证书主机名

证书的主要作用就是为保障用户安全顺畅地访问域名建议合适的信任机制。在互联网上，用户经常会收到一些证书域名不匹配的警告，这往往是由于使用的证书不能匹配该域名的不同变体（比如证书域名是        www.example.com，无法匹配example.com域名）。为了避免上述问题，请遵守一个简单的规则：只要有一个DNS解析指向你的TLS服务器，就务必保证你的证书包括了这个DNS域名。

### 证书共享

证书共享大致分为两种类型。第一种：你可以签发一个包含所有需要域名的证书（例如，www.example.com、example.com和log.example.com）。第二种：你可以签发一个泛域名证书，可用于所有关联的子域名（例如，签发一个*.example.com和example.com的泛域名证书）。

原则上，使用多域名证书并没有什么问题，但前提是它不会降低你的系统安全性，而现实是这种证书的使用确实会对安全性有影响。从本质上来讲，当多个域名共用一个证书时，事实上它们也就共用了一个相同的私钥。因此，当你的一组网站是由不同团队运营或者根本各不相关时，就不应该对这些网站使用多域名证书。因为如果其中一个网站被攻击，被窃取的私钥就可以用来攻击所有共用这个证书的其他网站，另外在发生攻击后，你也需要对这组网站全部更新一遍密钥。

### 签名算法

为了保证证书的有效性，CA在签发证书时会对证书进行数字签名。数字签名的安全性依赖于两个方面：一个是CA的私钥长度，另一个是散列算法的强度。

对于新申请的证书，要确保使用SHA256或更好的签名算法。申请证书前你需要提前与CA确认好签名算法，因为签名算法的选择不是在你提交的CSR里设定的。

### 证书链

虽然我们一直在讨论服务器证书，但实际上我们在部署TLS服务器时真正需要配置的是证书链（certificate chain）。一个证书链就是能溯源到一个可信根证书的有序证书列表。

一些UA知道如何重建不完整的证书链，有两种常见的方法：(1) 预置并缓存所有的中间CA证书；(2) UA从证书内置的父证书信息中取得链接地址并自动获取。这两种方法都不可靠，第二种方法还会降低用户访问速度，因为UA还需要从CA网站上下载证书链来验证证书的有效性。

###  证书吊销

证书可以提供两种类型的吊销信息：CRL和OCSP。尽管不包含吊销信息的证书十分罕见，你还是应该检查一下自己的证书（比如使用SSLLabs检查网站，或者用OpenSSL的命令行工具）。

更为重要的是，你的CA需要提供一个可靠和快速的OCSP响应服务。因为每一次用户连接到你的网站，就会同样触发一次到CA站点的查询。为了获得最佳效果和可靠性，建议启用OCSP stapling特性。启用后，你的Web服务器可以直接返回OCSP响应，以避免因依赖CA网站而引起的性能、可用性和隐私方面的潜在问题。

### 选择合适的CA

对于一个只需要DV证书的小网站，理论上所有CA都没问题。你可以随意选择，找一家最便宜的CA就行。任何公共CA都可以直接签发DV证书，并且无需你提供任何信息，为什么要付更多的钱呢？但是，如果你的证书需要用来保护重要的资产，花一点时间仔细选择，确保CA能满足你的所有需求。假如你还需要启用像钉扎这样的高级特性，选择一个CA将会是一个长期的承诺，请更加谨慎地选择。


## 协议配置

在配置TLS协议时，你通常是根据安全性和互操作性的组合来作出选择的。在理想的环境中，只需要考虑安全性，因此你可以启用TLS 1.2并且禁用其他所有的版本。实际上，这种方案只能用于很少的场合或者严格可控的环境中。尽管现代浏览器都支持TLS 1.2，但其它许多产品和工具不一定支持。

一个常见的公共网站通常支持TLS 1.0、TLS 1.1和TLS 1.2。SSL 2和SSL 3已基本废弃并且不安全。


## 密码套件配置

影响密码套件配置的几个方面：加密强度、长期安全性、性能和互操作性。

### 服务器密码套件配置优先

无论你有什么样的客户端，强制服务器密码套件配置优先是确保最佳安全至关重要的一点。密码套件的选择是在TLS握手期间决定的，而TLS协议确保了握手的完整性，强制服务器算法优先后，网络攻击者就无法通过强制选择弱密码套件来发起攻击。

即使启用了服务器密码套件优先，仍然不应该配置不安全的套件。网络攻击者可以强制一个浏览器来自动将协议降级到最差的版本，如果你的服务器还在支持SSL 3，这意味着潜在的风险：加密没有身份验证，无法启用EC算法，有时甚至不能使用AES算法。

### 加密强度

务必使用128位以上强度的加密算法

### 前向保密

议不要使用RSA密钥交换，因为它不支持前向保密。RSA可以同时用于密钥交换和身份验证，不要搞混了，RSA用于身份验证是完全没有问题的，如果你使用的是RSA私钥，字符串RSA还是会出现在密码套件的名称中。推荐选择名称中包含字符串ECDHE或DHE的密码套件，从性能方面来说，ECDHE套件优于DHE套件。

使用前向保密后，用户的每次访问都会使用不同的密钥独立加密。如果没有前向保密，所有连接的安全性都完全依赖于服务器的密钥，一旦服务器密钥被破解或者泄露，所有历史通信都可以被直接解密，这是一个巨大的隐患。

### 性能

### 互操作性

互操作性的关键是提供尽量多的密码套件选择。TLS客户端是多种多样的，想必你也不愿无谓地丢弃掉一部分客户。如果你能按照此处的建议并设置好服务器算法优先，就可以让大多数客户端都在优选的密码套件上工作，而对于那些支持有限的老客户端则在降级的密码套件上工作。


## 会话缓存

会话缓存是性能优化的常见方案，客户端和服务器在首次建立连接并创建SSL会话时协商好传输密钥，在后续连接中就可以直接复用相同的传输密钥，大大减少CPU消耗和网络延迟。这个措施会导致安全性的降低，假如传输密钥被破解，整个会话的所有通信都可能被破解，但是一般情况下会话只会持续很有限的时间，所以这个折中方案被广泛应用于实际部署中。


## 钉扎

互联网的信任机制完全依赖于数百家CA厂商颁发的证书，证书用来验证服务器的合法性。对于一般的网站来讲，这种方法很适用，因为这些网站不太可能被伪造证书；高知名度网站的风险则高得多，原因在于任意一个CA都可以签发任意一个域名的证书。为了避免这个问题，可以使用一种被称为公钥钉扎（public key pinning）的技术，它允许你强制指定签发证书的CA，只有被指定的CA为你的域名签发的证书才能正常使用。

钉扎技术大大降低了证书伪造的攻击可能性，但是也需要付出一些代价：需要一定的投入才能建立起一个成熟的钉扎战略和运营机制，并且钉扎完全依赖于浏览器的内部验证机制。关于钉扎技术有几个不同的标准，目前正处于不同的发展阶段：DANE（基于DNSSEC）、HTTP公钥钉扎和TACK。
 

## HTTP     

### HTTP严格传输安全

HTTP严格传输安全（HTTP strict transport security, HSTS）是一种标准，允许网站强制要求客户端使用加密方式，网站通过返回一个HTTP响应头来给浏览器指定策略。一旦服务器启用HSTS后，支持这一特性的浏览器将始终使用TLS与网站通信。

HSTS可以禁止浏览器使用无效证书。在没有启用HSTS时，浏览器在遇到无效证书时会提示用户，但仍然允许用户继续访问，大多数用户无法区分这是攻击还是配置问题，因此往往会选择继续访问，从而导致很容易遭受网络攻击。当HSTS启用后，证书验证失败时用户将无法绕过，也就无法继续访问。

### 内容安全策略

内容安全策略（Content Security Policy, CSP）是一种机制，允许网站控制在HTML页面中嵌入的资源用什么协议来访问。与HSTS一样，网站通过返回一个HTTP响应头来给浏览器指定策略。尽管CSP最初是设计用来对抗XSS攻击的，但它实际上在网站加密方面起了更重要的作用：通过拒绝明文链接策略，可以禁用页面中的第三方混合内容。

