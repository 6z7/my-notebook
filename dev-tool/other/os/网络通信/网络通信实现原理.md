# 网络通信实现原理

要想实现网络通信，每台主机需具备四要素：本机的IP地址、子网掩码、网关的IP地址和DNS的IP地址。

获取这四要素有两种方式：一是静态获取，即手动配置；二是动态获取，即通过DHCP（Dynamic HostConfiguration Protocol，动态主机配置协议）获取。

通过DHCP获取配置：

![](./img/17.jpeg)

1. 最前面的“以太网头部”，设置发出方（本机）的MAC地址和接收方（DHCP服务器）的MAC地址。前者就是本机网卡的MAC地址，后者这时不知道，就填入一个广播地址：FF-FF-FF-FF-FF-FF。

2. 后面的“IP头部”，设置发出方的IP地址和接收方的IP地址。这时，对于这两者，本机都不知道。于是，发出方的IP地址就设为0.0.0.0，接收方的IP地址设为255.255.255.255。

3. 最后的“UDP头部”，设置发出方的端口和接收方的端口。这一部分是DHCP规定好的，发出方是68端口，接收方是67端口。

这个数据包构造完成后，就可以发出了。以太网是广播发送的，同一个子网的每台计算机都收到了这个数据包。因为接收方的MAC地址是FF-FF-FF-FF-FF-FF，看不出是发给谁的，所以每台收到这个数据包的计算机，还必须分析这个数据包的IP地址，才能确定是不是发给自己的。看到发出方IP地址是0.0.0.0，接收方IP地址是255.255.255.255，于是DHCP服务器知道“这个数据包是发给我的”，而其他计算机就可以丢弃这个数据包。

接下来，DHCP服务器读出这个数据包的数据内容，分配好IP地址，发送回去一个“DHCP响应”数据包。这个响应包的结构也是类似的，以太网头部的MAC地址是双方的网卡地址，IP头部的IP地址是DHCP服务器的IP地址（发出方）和255.255.255.255（接收方），UDP头部的端口是67（发出方）和68（接收方），分配给请求端的IP地址和本网络的具体参数则包含在Data部分。新加入的计算机收到这个响应包，于是就知道了自己的IP地址、子网掩码、网关地址、DNS服务器等参数。