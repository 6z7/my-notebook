# 数据模型

etcd旨在可靠地存储不经常更新的数据并提供可靠的监视查询。etcd可以查看历史版本的键值对，以支持快照和监视历史事件。持久的多版本并发控制数据模型非常适合这些场景。

etcd将数据存储在多版本持久键值存储中。当值被新数据取代时，它会保留键值对的先前版本。键值存储实际上是不可变的；其操作不会更新结构，而是始终生成新的结构。修改后，所有以前的key版本仍然可以访问和监视。为了防止数据存储随时间无限期增长，可以压缩存储以释放掉旧版本的数据。

## 逻辑视图

存储的逻辑视图是一个平面二进制键空间。键空间在字节字符串键上有一个按词法排序的索引，因此范围查询很花费很低。

键空间维护多个修订版本。新建时初始版本是1。每个原子操作会在键空间上创建一个新的版本号。之前的版本数据都保持不变。key的旧版本仍然通过版本号访问到。如果进行压缩存储以节省空间，则会删除压缩的指定版本之前的所有修订版本。在集群的整个生命周期内，版本号都是单调增加的。

从创建到删除，key的生命周期跨越了一个世代。每个key可以具有一个或多个世代。创建key会增加该key的版本号，如果该key在当前版本中不存在，则从1开始。删除key将生成一个墓碑key，通过将键的版本重置为0来实现。每次key的修改都会增加版本号。一旦发生压缩指定版本之前的key都会被删除了最新的key。


## 物理视图

etcd将数据以键值对形式存储在B+树中。为了提高效率，存储状态的每个修订版仅包含其先前修订版的增量，单个修订版可能对应于树中的多个键。

键值对的键是3元组(major,sub,type)。Major是key对应的修订版本，Sub区分同一修订版中的键，Type是特殊值的可选后缀(如，值包含一个墓碑)。值对的值包含先前版本的修改，包含先前版本的增量。B+树通过键以词法字节顺序排序

etcd还在内存中保留一个二级btree索引，以加快对键的范围查询。btree索引中的键是向用户公开的键，该值是指向持久性B+树修改的指针，压缩将删除死指针。